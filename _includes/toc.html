<!-- ═══════════════════════════════════════════════════════
     TOC — Tabla de contenidos
     Desktop : widget inyectado en #toc-widget-container (sidebar)
     Mobile  : acordeón inline justo antes del contenido
     Requiere ≥ 2 headings en .post-content para activarse
     ═══════════════════════════════════════════════════════ -->

<!-- Contenedor inline: visible solo en mobile/tablet (<1024px) -->
<div class="toc-inline" id="toc-inline" aria-label="Tabla de contenidos" hidden>
  <button class="toc-inline-header" id="toc-inline-toggle"
          aria-expanded="false" aria-controls="toc-inline-body">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2.2" aria-hidden="true">
      <line x1="3" y1="6"  x2="21" y2="6"/>
      <line x1="3" y1="12" x2="15" y2="12"/>
      <line x1="3" y1="18" x2="18" y2="18"/>
    </svg>
    <span>En este artículo</span>
    <svg class="toc-chevron" width="14" height="14" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
      <polyline points="6 9 12 15 18 9"/>
    </svg>
  </button>
  <div class="toc-inline-body" id="toc-inline-body" hidden></div>
</div>

<style>
/* ═══════════════════════════════════════════════════════
   TOC — estilos compartidos
   ═══════════════════════════════════════════════════════ */

/* ── Links (compartidos entre sidebar y mobile) ─────── */
.toc-link {
  display: block;
  font-family: var(--font-sans);
  font-size: 0.8rem;
  line-height: 1.4;
  color: var(--color-text-muted);
  text-decoration: none;
  padding: 0.3rem 0.5rem 0.3rem 0.6rem;
  border-left: 2px solid transparent;
  border-radius: 0 4px 4px 0;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
}

.toc-link--sub {
  padding-left: 1.35rem;
  font-size: 0.75rem;
}

.toc-link:hover {
  color: var(--color-text);
  background: rgba(243,79,41,0.05);
  border-left-color: rgba(243,79,41,0.35);
}

.toc-link.toc-active {
  color: var(--color-orange);
  font-weight: 600;
  border-left-color: var(--color-orange);
  background: rgba(243,79,41,0.06);
}

/* ── Sidebar widget (solo desktop) ──────────────────── */
.widget-toc {
  border-top: 3px solid var(--color-orange);
  background: #fafaf8;
  padding: 1.25rem 1.25rem 0.75rem;
}

.widget-toc .widget-heading {
  margin-bottom: 0.75rem;
}

.toc-nav {
  display: flex;
  flex-direction: column;
  margin: 0 -0.5rem;
}

/* ── Inline / mobile ─────────────────────────────────── */
.toc-inline {
  background: rgba(243,79,41,0.03);
  border: 1px solid rgba(243,79,41,0.2);
  border-radius: 8px;
  margin-bottom: 1.75rem;
  overflow: hidden;
}

.toc-inline-header {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  width: 100%;
  padding: 0.85rem 1rem;
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--font-sans);
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--color-text);
  text-align: left;
}

.toc-inline-header svg:first-child {
  flex-shrink: 0;
  color: var(--color-orange);
}

.toc-chevron {
  flex-shrink: 0;
  margin-left: auto;
  transition: transform 0.25s ease;
}

.toc-inline-header[aria-expanded="true"] .toc-chevron {
  transform: rotate(180deg);
}

.toc-inline-body {
  padding: 0.35rem 0.75rem 0.85rem;
  border-top: 1px solid rgba(243,79,41,0.12);
  display: flex;
  flex-direction: column;
}

.toc-inline-body .toc-link {
  font-size: 0.83rem;
  padding: 0.38rem 0.5rem 0.38rem 0.7rem;
}

/* ── Responsive ─────────────────────────────────────── */
@media (min-width: 1025px) {
  /* Solo en desktop: ocultar el inline (la sidebar maneja el TOC) */
  .toc-inline { display: none !important; }
}

@media (max-width: 1024px) {
  /* En mobile/tablet la sidebar ya está oculta,
     el widget-toc tampoco se muestra allí */
  .widget-toc { display: none !important; }
}
</style>

<script>
(function () {
  'use strict';

  document.addEventListener('DOMContentLoaded', function () {
    var postContent = document.querySelector('.post-content');
    if (!postContent) return;

    /* ── 1. Recopilar headings ─────────────────────── */
    var headings = Array.from(postContent.querySelectorAll('h2, h3'));
    if (headings.length < 2) return; /* Menos de 2 secciones → no vale la pena */

    /* ── 2. Asignar IDs a los headings ─────────────── */
    var usedIds = {};
    headings.forEach(function (h) {
      if (!h.id) {
        var base = h.textContent.trim()
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');
        var id = base || 'section';
        var n = 1;
        while (usedIds[id]) { id = base + '-' + (++n); }
        usedIds[id] = true;
        h.id = id;
      }
    });

    /* ── 3. Crear elementos <a> del TOC ────────────── */
    function makeLink(h) {
      var a = document.createElement('a');
      a.href = '#' + h.id;
      a.className = 'toc-link' + (h.tagName === 'H3' ? ' toc-link--sub' : '');
      a.dataset.target = h.id;
      a.textContent = h.textContent.trim();
      /* Smooth scroll + cierre del panel mobile */
      a.addEventListener('click', function (e) {
        if (window.innerWidth < 1025) {
          var body = document.getElementById('toc-inline-body');
          var toggle = document.getElementById('toc-inline-toggle');
          if (body && !body.hidden) {
            body.hidden = true;
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
          }
        }
      });
      return a;
    }

    /* ── 4. Poblar sidebar (desktop) ───────────────── */
    var sidebarWidget = document.getElementById('toc-widget-container');
    var sidebarNav    = document.getElementById('toc-nav-list');
    if (sidebarWidget && sidebarNav) {
      headings.forEach(function (h) {
        sidebarNav.appendChild(makeLink(h));
      });
      sidebarWidget.removeAttribute('style'); /* quitar display:none */
    }

    /* ── 5. Poblar TOC inline (mobile) ─────────────── */
    var inlineToc    = document.getElementById('toc-inline');
    var inlineBody   = document.getElementById('toc-inline-body');
    var inlineToggle = document.getElementById('toc-inline-toggle');
    if (inlineToc && inlineBody && inlineToggle) {
      headings.forEach(function (h) {
        inlineBody.appendChild(makeLink(h));
      });
      inlineToc.hidden = false;

      inlineToggle.addEventListener('click', function () {
        var open = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !open);
        inlineBody.hidden = open;
      });
    }

    /* ── 6. Intersection Observer: sección activa ──── */
    var allLinks = [];
    [sidebarNav, inlineBody].forEach(function (container) {
      if (container) {
        allLinks = allLinks.concat(Array.from(container.querySelectorAll('.toc-link')));
      }
    });

    var observer = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          var id = entry.target.id;
          allLinks.forEach(function (l) {
            l.classList.toggle('toc-active', l.dataset.target === id);
          });
        }
      });
    }, { rootMargin: '-8% 0px -82% 0px', threshold: 0 });

    headings.forEach(function (h) { observer.observe(h); });
  });
}());
</script>
